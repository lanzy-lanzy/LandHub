<!-- Toast Notification Component -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" x-data="toastManager()">
    <!-- Toast notifications will be dynamically added here -->
</div>

<script>
function toastManager() {
    return {
        toasts: [],
        
        addToast(type, title, message, duration = 5000) {
            const id = Date.now() + Math.random();
            const toast = {
                id: id,
                type: type, // 'success', 'error', 'warning', 'info'
                title: title,
                message: message,
                show: false
            };
            
            this.toasts.push(toast);
            
            // Trigger show animation
            this.$nextTick(() => {
                const toastElement = document.querySelector(`[data-toast-id="${id}"]`);
                if (toastElement) {
                    toast.show = true;
                }
            });
            
            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    this.removeToast(id);
                }, duration);
            }
            
            return id;
        },
        
        removeToast(id) {
            const index = this.toasts.findIndex(toast => toast.id === id);
            if (index > -1) {
                this.toasts[index].show = false;
                setTimeout(() => {
                    this.toasts.splice(index, 1);
                }, 300); // Wait for animation to complete
            }
        },
        
        getToastClasses(type) {
            const baseClasses = 'max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 ease-in-out';
            const typeClasses = {
                'success': 'border-l-4 border-green-400',
                'error': 'border-l-4 border-red-400',
                'warning': 'border-l-4 border-yellow-400',
                'info': 'border-l-4 border-blue-400'
            };
            return `${baseClasses} ${typeClasses[type] || typeClasses.info}`;
        },
        
        getIconClasses(type) {
            const iconClasses = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'info': 'text-blue-400'
            };
            return iconClasses[type] || iconClasses.info;
        },
        
        getIcon(type) {
            const icons = {
                'success': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />',
                'error': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />',
                'warning': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />',
                'info': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
            };
            return icons[type] || icons.info;
        }
    }
}

// Global function to show toast notifications
window.showToast = function(type, title, message, duration = 5000) {
    const toastContainer = document.querySelector('#toast-container');
    if (toastContainer && toastContainer._x_dataStack) {
        toastContainer._x_dataStack[0].addToast(type, title, message, duration);
    }
};

// Listen for HTMX events to show notifications
document.addEventListener('htmx:afterRequest', function(event) {
    const response = event.detail.xhr;
    
    // Check for notification data in response headers
    const notificationData = response.getResponseHeader('X-Notification');
    if (notificationData) {
        try {
            const notification = JSON.parse(notificationData);
            showToast(notification.type, notification.title, notification.message, notification.duration);
        } catch (e) {
            console.error('Error parsing notification data:', e);
        }
    }
    
    // Show success message for successful form submissions
    if (response.status >= 200 && response.status < 300) {
        const target = event.detail.target;
        if (target && target.tagName === 'FORM') {
            showToast('success', 'Success', 'Action completed successfully');
        }
    }
});

// Listen for notification-specific events
document.addEventListener('notification:new', function(event) {
    const { type, title, message, duration } = event.detail;
    showToast(type, title, message, duration);
});
</script>

<!-- Toast Template (rendered by Alpine.js) -->
<template x-for="toast in toasts" :key="toast.id">
    <div :data-toast-id="toast.id"
         :class="getToastClasses(toast.type)"
         x-show="toast.show"
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
         x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg :class="getIconClasses(toast.type)" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-html="getIcon(toast.type)">
                    </svg>
                </div>
                <div class="ml-3 w-0 flex-1 pt-0.5">
                    <p class="text-sm font-medium text-gray-900" x-text="toast.title"></p>
                    <p class="mt-1 text-sm text-gray-500" x-text="toast.message"></p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button @click="removeToast(toast.id)"
                            class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>
